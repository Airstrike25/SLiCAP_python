

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SLiCAP math library &mdash; SLiCAP Programming 1.0.2020 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/myStyle.css" type="text/css" />
  

  
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="SLiCAP Programming 1.0.2020 documentation" href="index.html"/>
        <link rel="next" title="Building the MNA matrices" href="matrices.html"/>
        <link rel="prev" title="SLiCAP configuration" href="configure.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="slicap-programming.html" class="icon icon-home"> SLiCAP Programming
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">SLiCAP open-source</a></li>
<li class="toctree-l1"><a class="reference internal" href="ToDo.html">ToDo</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure.html">SLiCAP configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SLiCAP math library</a></li>
<li class="toctree-l1"><a class="reference internal" href="matrices.html">Building the MNA matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythonMaximaInterface.html">Python-Maxima interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="html.html">HTML reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">SLiCAP netlist parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="parsingMethod.html">Parsing method</a></li>
<li class="toctree-l1"><a class="reference internal" href="modelParams.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="subCircuits.html">Sub circuits</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">SLiCAP Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="execute.html">Execute</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="SLiCAPreference.html">SLiCAP Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="slicap-programming.html">SLiCAP Programming</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="slicap-programming.html">Docs</a> &raquo;</li>
        
      <li>SLiCAP math library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/math.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="slicap-math-library">
<h1>SLiCAP math library<a class="headerlink" href="#slicap-math-library" title="Permalink to this headline">Â¶</a></h1>
<p>The SLiCAP math library contains a matrix class which is a sub class of the Sympy Matrix class. The execution time of the methods belonging to this class is shorter than comparable methods in Sympy, but still much slower than comparable methods in Maxima CAS.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SLiCAP module with extended matrix class and SLiCAP math functions.</span>

<span class="sd">Imported by the module **SLiCAPprotos.py**.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">SLiCAPlex</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">matrix</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SLiCAP matrix class for symbolic calculations.</span>
<span class="sd">    </span>
<span class="sd">    This class is an extension to the sympy Matrix class. It calculates</span>
<span class="sd">    determinants using minor expansion</span>
<span class="sd">    return types for matrices are &lt;class &#39;sympy.matrices.matrices.Matrix&#39;&gt;.</span>
<span class="sd">    </span>
<span class="sd">    Determination of determinants is slow. SLiCAP uses Maxima CAS for this</span>
<span class="sd">    purpose.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Adapted from: from &quot;Bill McNeill &lt;billmcn@speakeasy.net&gt;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">minor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns determinant of M after deleting row i and column j</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minor_submatrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span><span class="o">.</span><span class="n">determinant</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">coFactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns cofactor C(i,j) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">minor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">minor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">determinant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns determinant calculated by expansion of minors.</span>
<span class="sd">        No multiplication with zero speeds up calculation for sparse matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">-=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expandByMinors</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">expandByMinors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates determinant by expansion of minors.</span>
<span class="sd">        No multiplications with zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>                
                <span class="k">if</span> <span class="n">col</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">minor</span><span class="p">(</span><span class="mi">0</span> <span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">-=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">minor</span><span class="p">(</span><span class="mi">0</span> <span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
                    
    <span class="k">def</span> <span class="nf">coFactorMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns cofactor matrix of M</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coFactor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">C</span>

    <span class="k">def</span> <span class="nf">adjugate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns adjugate matrix of M</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coFactorMatrix</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns inverse matrix of M</span>
<span class="sd">        return self.adjugate()/self.determinant()</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">dotV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Vr</span><span class="p">,</span> <span class="n">Vc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns inner product of row vector Vr and column vector Vc.</span>
<span class="sd">        No multiplications with zero or +/- unity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">Vr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="o">-</span><span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="o">-</span><span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns product of two matrices M1 and M2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">s1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">mult</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotV</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">M2</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">mult</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Incompatible matrix dimensions&#39;</span>
            
    <span class="k">def</span> <span class="nf">Cramer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colVector</span><span class="p">,</span> <span class="n">colNumber</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns matrix with colVector substituted in column colNumber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newMatrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">newMatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">newMatrix</span><span class="p">[:,</span><span class="n">colNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">colVector</span>
        <span class="k">return</span> <span class="n">newMatrix</span>

<span class="k">def</span> <span class="nf">polyCoeffs</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list with coefficients of &#39;var&#39; in descending order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">all_classes</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">all_classes</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">Poly</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">all_coeffs</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">numRoots</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Using numpy for calculation of numeric roots is about 60 times faster than </span>
<span class="sd">    using sympy.roots(expr, var)</span>
<span class="sd">    numpy.roots: </span>
<span class="sd">        https://docs.scipy.org/doc/numpy/reference/generated/numpy.polynomial.polynomial.polyroots.html</span>
<span class="sd">        The root estimates are obtained as the eigenvalues of the companion matrix.</span>
<span class="sd">        Roots far from the origin of the complex plane may have large errors due to </span>
<span class="sd">        the numerical instability of the power series for such values. Roots with </span>
<span class="sd">        multiplicity greater than 1 will also show larger errors as the value of </span>
<span class="sd">        the series near such points is relatively insensitive to errors in the roots. </span>
<span class="sd">        Isolated roots near the origin can be improved by a few iterations of </span>
<span class="sd">        Newton&#39;s method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">all_classes</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">all_classes</span><span class="p">)):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Error: symbolic variables found, cannot determine roots.&quot;</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">polyCoeffs</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="p">)</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[]</span>
    
<span class="k">def</span> <span class="nf">makeLaplaceRational</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">poles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Laplace rational from a gain factor, a list of zeros and a list</span>
<span class="sd">    of poles:</span>
<span class="sd">        </span>
<span class="sd">        F(s) = gain * product_j(s-z_j) / product_i(s-p_i)</span>
<span class="sd">        </span>
<span class="sd">    Terms with complex conjugated poles or zeros will be combined into </span>
<span class="sd">    quadratic terms.</span>
<span class="sd">    </span>
<span class="sd">    The gain factor should be taken as the ratio of the coefficients of the </span>
<span class="sd">    highest order of the Laplace variable of the numerator and the denominator:</span>
<span class="sd">    this is not the DC gain!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Fs</span> <span class="o">=</span> <span class="n">gain</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zeros</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">im</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Fs</span> <span class="o">*=</span> <span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sp</span><span class="o">.</span><span class="n">im</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Fs</span> <span class="o">*=</span> <span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">im</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">im</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Fs</span> <span class="o">/=</span> <span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sp</span><span class="o">.</span><span class="n">im</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Fs</span> <span class="o">/=</span> <span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span> <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">im</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">Fs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">coeffsTransfer</span><span class="p">(</span><span class="n">LaplaceRational</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a nested list with the coefficients of the Laplace variable of the </span>
<span class="sd">    numerator and of the denominator of LpalaceRational.</span>
<span class="sd">    The coefficients are in ascending order.</span>
<span class="sd">    ToDo:</span>
<span class="sd">        </span>
<span class="sd">        Factorization and simplification according to ini settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">numer</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span><span class="n">LaplaceRational</span><span class="p">)</span>
    <span class="n">coeffsNumer</span> <span class="o">=</span> <span class="n">polyCoeffs</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span> <span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="p">)</span>
    <span class="n">coeffsDenom</span> <span class="o">=</span> <span class="n">polyCoeffs</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="n">ini</span><span class="o">.</span><span class="n">Laplace</span><span class="p">)</span>
    <span class="n">coeffsNumer</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffsNumer</span><span class="p">)):</span>
        <span class="n">coeffsNumer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">coeffsNumer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">coeffsDenom</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffsDenom</span><span class="p">)):</span>
        <span class="n">coeffsDenom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">coeffsDenom</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">coeffN</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">coeffD</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">gain</span>   <span class="o">=</span> <span class="mi">1</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffsNumer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">coeffsNumer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">coeffN</span> <span class="o">=</span> <span class="n">coeffsNumer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffsDenom</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">coeffsDenom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">coeffD</span> <span class="o">=</span> <span class="n">coeffsDenom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">coeffN</span><span class="o">/</span><span class="n">coeffD</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffsNumer</span><span class="p">)):</span>
        <span class="n">coeffsNumer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">coeffsNumer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">coeffN</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffsDenom</span><span class="p">)):</span>
        <span class="n">coeffsDenom</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">coeffsDenom</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">coeffD</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="n">coeffsNumer</span><span class="p">,</span> <span class="n">coeffsDenom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalizeLaplaceRational</span><span class="p">(</span><span class="n">LaplaceRational</span><span class="p">):</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Normalizes a Laplace rational:</span>
<span class="s2">        </span>
<span class="s2">        F(s) = gain * s^l (1+b_1*s + ... + b_m*s^m)/ (1+a_1*s + ... + a_n*s^n)</span>

<span class="s2">        with l zero if there is a finite nonzero zero-frequency value, else</span>
<span class="s2">        positive or negative</span>
</pre></div>
</td></tr></table></div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="matrices.html" class="btn btn-neutral float-right" title="Building the MNA matrices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configure.html" class="btn btn-neutral" title="SLiCAP configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, SLiCAP development team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.2020',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>